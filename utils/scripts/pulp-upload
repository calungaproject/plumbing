#!/usr/bin/env bash
set -euo pipefail

cd "${FILES_DIR}"
ls -la .

REPOSITORY_URL="${PULP_BASE_URL}${PULP_API_ROOT}pypi/${PULP_DOMAIN}/${PULP_REPOSITORY}/simple/"

export TWINE_USERNAME=$(< /etc/service-account-secret/username)
export TWINE_PASSWORD=$(< /etc/service-account-secret/password)

# Check if we have attestation files
shopt -s nullglob

for file in *.whl *.tar.gz; do
    echo "Trying to upload $file..."
    if ! twine upload --non-interactive --verbose --repository-url "${REPOSITORY_URL}" --attestations $file; then
        echo "Failed to upload $file with attestation."
        if ! twine upload --non-interactive --verbose --repository-url "${REPOSITORY_URL}" $file; then
            echo "Failed to upload $file without attestation."
            echo "Skipping this file due to failures."
        fi
    fi
done

echo "Upload complete!"
echo "Index URL: ${REPOSITORY_URL}"
