#!/usr/bin/env bash
set -euo pipefail

cd "${FILES_DIR}"
ls -la .

REPOSITORY_URL="${PULP_BASE_URL}${PULP_API_ROOT}pypi/${PULP_DOMAIN}/${PULP_REPOSITORY}/simple/"
INDEX_URL="${PULP_BASE_URL}${PULP_API_ROOT}pulp-content/${PULP_DOMAIN}/${PULP_REPOSITORY}/simple/"

export TWINE_USERNAME=$(< /etc/service-account-secret/username)
export TWINE_PASSWORD=$(< /etc/service-account-secret/password)

# Check if we have attestation files
shopt -s nullglob
attestation_files=(*.attestation)

if [ ${#attestation_files[@]} -gt 0 ]; then
    echo "Uploading packages with attestations..."
    twine upload --non-interactive --repository-url "${REPOSITORY_URL}" --attestations *.whl *.tar.gz *.attestation
else
    echo "Uploading packages..."
    twine upload --non-interactive --repository-url "${REPOSITORY_URL}" *.whl *.tar.gz
fi

rm -f "${CLIENT_CERT_FILE}"

echo ""
echo "Upload complete!"
echo "Index URL: ${INDEX_URL}"
