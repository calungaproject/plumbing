apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: extract-py-artifacts
spec:
  description: |
    Extract Python packages from OCI artifacts for signing and upload.
  params:
    - name: SNAPSHOT_PATH
      type: string
      description: Path to the snapshot spec file containing image information
    - name: sourceDataArtifact
      type: string
      description: Trusted Artifact to use to obtain the Snapshot
    - name: dataDir
      type: string
      description: The location where data will be stored
      default: /var/workdir
    - name: filesDir
      type: string
      description: The relative path within dataDir where files will be extracted
      default: files
    - name: ociStorage
      type: string
      description: The OCI repository where the Trusted Artifacts are stored
    - name: ociArtifactExpiresAfter
      type: string
      description: Expiration date for the trusted artifacts created
      default: "1d"
  results:
    - name: sourceDataArtifact
      description: Produced trusted data artifact
      type: string
  volumes:
    - name: workdir
      emptyDir: {}
  stepTemplate:
    env:
      - name: SNAPSHOT_PATH
        value: $(params.SNAPSHOT_PATH)
      - name: IMAGES_TXT
        value: $(params.dataDir)/images.txt
      - name: FILES_DIR
        value: $(params.dataDir)/$(params.filesDir)
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.ociArtifactExpiresAfter)
      - name: TRUSTED_ARTIFACTS_EXTRACT_DIR
        value: $(params.dataDir)
    volumeMounts:
      - name: workdir
        mountPath: /var/workdir
    workingDir: /var/workdir
  steps:
    - name: use-trusted-artifact
      args:
        - use
        - $(params.sourceDataArtifact)=$(params.dataDir)
      computeResources: {}
      image: quay.io/redhat-appstudio/build-trusted-artifacts:e02102ede09aa07187cba066ad547a54724e5cf4
    - name: get-image-urls
      image: quay.io/konflux-ci/buildah-task:latest@sha256:b82d465a06c926882d02b721cf8a8476048711332749f39926a01089cf85a3f9
      script: |
        #!/bin/bash
        set -euo pipefail

        < "${TRUSTED_ARTIFACTS_EXTRACT_DIR}/${SNAPSHOT_PATH}" jq -r '.components[].containerImage' | tee "${IMAGES_TXT}"

    - name: extract-artifacts
      image: quay.io/konflux-ci/oras:latest@sha256:1beeecce012c99794568f74265c065839f9703d28306a8430b667f639343a98b
      script: |
        #!/bin/bash
        set -euo pipefail

        AUTHFILE='/tmp/auth.json'
        mkdir -p "${FILES_DIR}"
        while read -r IMAGE; do
          echo "Processing ${IMAGE}"
          select-oci-auth "${IMAGE}" > "${AUTHFILE}"
          retry oras pull --registry-config "${AUTHFILE}" "${IMAGE}" -o "${FILES_DIR}"
        done < "${IMAGES_TXT}"

        echo "Extracted files:"
        ls -la "${FILES_DIR}"

    - name: create-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:e02102ede09aa07187cba066ad547a54724e5cf4
      args:
        - create
        - --store
        - $(params.ociStorage)
        - $(results.sourceDataArtifact.path)=$(params.dataDir)
