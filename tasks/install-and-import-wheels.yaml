apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: install-and-import-wheels
spec:
  description: >-
    Extracts the built Python wheels from the SNAPSHOT, installs them
    onto the specified TEST_IMAGE, and tries to import the packages.
  params:
    - description: The JSON string of the Snapshot under test
      name: SNAPSHOT
      type: string
    - description: The image used for smoke testing the built wheels
      name: TEST_IMAGE
      type: string
  volumes:
    - name: workdir
      emptyDir: {}
  stepTemplate:
    env:
      - name: SNAPSHOT
        value: $(params.SNAPSHOT)
      - name: IMAGES_TXT
        value: /var/workdir/images.txt
      - name: FILES_DIR
        value: /var/workdir/files
    volumeMounts:
      - name: workdir
        mountPath: /var/workdir
  steps:
    - name: get-image-urls
      image: quay.io/konflux-ci/buildah-task:latest@sha256:b82d465a06c926882d02b721cf8a8476048711332749f39926a01089cf85a3f9
      script: |
        #!/bin/bash
        set -euo pipefail

        jq -r '.components[].containerImage' <<< "${SNAPSHOT}" | tee "${IMAGES_TXT}"

    - name: extract-wheels
      image: quay.io/konflux-ci/oras:latest@sha256:1beeecce012c99794568f74265c065839f9703d28306a8430b667f639343a98b
      script: |
        #!/bin/bash
        set -euo pipefail

        AUTHFILE='/tmp/auth.json'
        mkdir -p "${FILES_DIR}"

        while read -r IMAGE; do
          echo "Processing ${IMAGE}"
          select-oci-auth "${IMAGE}" > "${AUTHFILE}"
          retry oras pull --registry-config "${AUTHFILE}" "${IMAGE}" -o "${FILES_DIR}"
        done < "${IMAGES_TXT}"

        ls -la "${FILES_DIR}"

    - name: install-and-import
      image: $(params.TEST_IMAGE)
      script: |
        #!/bin/bash
        set -euo pipefail

        if command -v dnf >/dev/null 2>&1; then
            dnf install -y python3.12
        elif command -v apt-get >/dev/null 2>&1; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y python3.12 python3.12-venv
        else
            echo "ERROR: No supported package manager found"
            exit 1
        fi

        # Setup the Python script to verify import
        cat <<'EOF' > /tmp/verify_import.py
        import importlib
        import importlib.metadata
        import sys
        from pathlib import Path

        # Get the Distribution Name correctly
        wheel_path = Path(sys.argv[1])
        dist_name = wheel_path.name.split('-')[0].replace('_', '-').lower()

        try:
            dist = importlib.metadata.distribution(dist_name)
        except importlib.metadata.PackageNotFoundError:
            print(f'ERROR: Distribution "{dist_name}" not found')
            sys.exit(1)

        import_names = set()

        # Check top_level.txt
        tl_content = dist.read_text('top_level.txt')
        if tl_content:
            import_names = {line.strip() for line in tl_content.splitlines() if line.strip()}

        # Check file list ONLY if top_level.txt was missing/empty
        if not import_names and dist.files:
            for p in dist.files:
                root = p.parts[0]
                # Filter out metadata directories and hidden files
                if not (root.endswith(('.dist-info', '.egg-info')) or root.startswith('.')):
                    name = Path(root).stem if root.endswith('.py') else root
                    import_names.add(name)

        if not import_names:
            print(f'ERROR: Could not determine any import names for {dist_name}')
            sys.exit(1)

        for name in sorted(import_names):
            # Skip private modules or explicit skips
            if name == 'tests' or name.endswith('.libs') or name.startswith('_'):
                continue

            try:
                print(f'Trying to import {name}...')
                importlib.import_module(name)
                print(f'Successfully imported {name}')
            except ImportError as e:
                print(f'ERROR: Failed to import {name}: {e}')
                sys.exit(1)
            except Exception as e:
                print(f'ERROR: Unexpected error: {e}')
                sys.exit(1)
        EOF

        echo "Changing directory to ${FILES_DIR}"
        cd "${FILES_DIR}"

        shopt -s nullglob

        whl_files=(*.whl)
        if [ ${#whl_files[@]} -eq 0 ]; then
            echo "ERROR: No .whl files found in ${FILES_DIR}"
            exit 1
        fi

        for WHEEL in "${whl_files[@]}"; do
            if [ -f "$WHEEL" ]; then
                echo "=================================================="
                echo "Testing $WHEEL..."

                rm -rf /tmp/test-venv
                echo "Setting up virtual environment..."
                python3.12 -m venv /tmp/test-venv

                echo "Installing wheel..."
                if ! /tmp/test-venv/bin/pip install --no-index --find-links . "${WHEEL}"; then
                    echo "ERROR: Installation failed for $WHEEL"
                    exit 1
                fi

                echo "Verifying import..."
                /tmp/test-venv/bin/python /tmp/verify_import.py "${WHEEL}"

                echo "Test successful for $WHEEL"
            fi
        done

        echo "=================================================="
        echo "Successfully tested all wheels!"
