---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sign-python-wheels
spec:
  description: >-
    Generate Sigstore attestations for Python wheels.
    
    This task creates SLSA provenance attestations for each wheel file,
    signs them using Sigstore, and outputs the attestation files alongside the wheels.
  params:
    - name: SNAPSHOT_PATH
      type: string
      description: Path to the snapshot spec file containing build metadata
    - name: SOURCE_ARTIFACT
      type: string
      description: The Trusted Artifact URI containing the snapshot
    - name: TRUSTED_ARTIFACTS_EXTRACT_DIR
      type: string
      default: "/var/workdir/ta"
      description: Directory to extract trusted artifacts
  results:
    - name: SIGNED_WHEELS_COUNT
      description: Number of wheels that were signed
  volumes:
    - name: workdir
      emptyDir: {}
  stepTemplate:
    volumeMounts:
      - name: workdir
        mountPath: "/var/workdir"
    workingDir: "/var/workdir"
  steps:
    - name: use-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:2712c8a6453fc9db5fc4c2d9d952554a4eea46d2fdba47a272b79fa07f8c8c40
      args:
        - use
        - $(params.SOURCE_ARTIFACT)=$(params.TRUSTED_ARTIFACTS_EXTRACT_DIR)
    - name: extract-wheels
      image: quay.io/konflux-ci/oras:latest@sha256:1beeecce012c99794568f74265c065839f9703d28306a8430b667f639343a98b
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "Extracting wheels from OCI artifacts..."
        
        # Get image URLs from snapshot
        SNAPSHOT_FILE="${TRUSTED_ARTIFACTS_EXTRACT_DIR}/$(params.SNAPSHOT_PATH)"
        mkdir -p wheels
        
        # Extract container images from snapshot
        jq -r '.components[].containerImage' "${SNAPSHOT_FILE}" | while read -r IMAGE; do
          echo "Processing ${IMAGE}"
          
          # Authenticate and pull
          AUTHFILE='/tmp/auth.json'
          select-oci-auth "${IMAGE}" > "${AUTHFILE}"
          retry oras pull --registry-config "${AUTHFILE}" "${IMAGE}" -o wheels/
        done
        
        echo "Wheels extracted:"
        ls -la wheels/
    - name: sign-wheels
      image: quay.io/konflux-ci/cosign:latest@sha256:1beeecce012c99794568f74265c065839f9703d28306a8430b667f639343a98b
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "Generating attestations for wheels..."
        
        # Extract metadata from snapshot
        SNAPSHOT_FILE="${TRUSTED_ARTIFACTS_EXTRACT_DIR}/$(params.SNAPSHOT_PATH)"
        
        # Get git metadata (will be same for all wheels in this release)
        GIT_URL=$(jq -r '.components[0].source.git.url // "unknown"' "${SNAPSHOT_FILE}")
        GIT_COMMIT=$(jq -r '.components[0].source.git.revision // "unknown"' "${SNAPSHOT_FILE}")
        BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        
        echo "Build metadata:"
        echo "  Git URL: ${GIT_URL}"
        echo "  Git Commit: ${GIT_COMMIT}"
        echo "  Build Time: ${BUILD_TIME}"
        
        SIGNED_COUNT=0
        
        cd wheels
        for WHEEL in *.whl *.tar.gz; do
          # Skip if no files match
          [ -e "${WHEEL}" ] || continue
          
          echo ""
          echo "Signing: ${WHEEL}"
          
          # Calculate wheel hash
          WHEEL_SHA256=$(sha256sum "${WHEEL}" | cut -d' ' -f1)
          
          # Create SLSA provenance predicate
          cat > /tmp/predicate.json <<EOF
        {
          "_type": "https://in-toto.io/Statement/v0.1",
          "predicateType": "https://slsa.dev/provenance/v0.2",
          "subject": [
            {
              "name": "${WHEEL}",
              "digest": {
                "sha256": "${WHEEL_SHA256}"
              }
            }
          ],
          "predicate": {
            "builder": {
              "id": "https://konflux-ci.dev/calunga"
            },
            "buildType": "https://konflux-ci.dev/PythonWheelBuild@v1",
            "invocation": {
              "configSource": {
                "uri": "${GIT_URL}",
                "digest": {
                  "sha1": "${GIT_COMMIT}"
                }
              }
            },
            "metadata": {
              "buildFinishedOn": "${BUILD_TIME}",
              "completeness": {
                "parameters": true,
                "environment": true,
                "materials": true
              },
              "reproducible": true
            }
          }
        }
        EOF
          
          # Sign with Sigstore (keyless via OIDC)
          # Konflux provides OIDC token automatically
          cosign attest-blob "${WHEEL}" \
            --predicate=/tmp/predicate.json \
            --type=slsaprovenance \
            --output-file="${WHEEL}.att"
          
          echo "âœ“ Created attestation: ${WHEEL}.att"
          SIGNED_COUNT=$((SIGNED_COUNT + 1))
          
          rm /tmp/predicate.json
        done
        
        echo ""
        echo "Signed ${SIGNED_COUNT} artifacts"
        echo "${SIGNED_COUNT}" > $(results.SIGNED_WHEELS_COUNT.path)
        
        echo ""
        echo "All signed artifacts:"
        ls -la
    - name: create-output-artifact
      image: quay.io/konflux-ci/oras:latest@sha256:1beeecce012c99794568f74265c065839f9703d28306a8430b667f639343a98b
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "Creating output artifact with wheels and attestations..."
        
        # Create output directory with wheels + attestations
        mkdir -p output
        cp wheels/* output/
        
        echo "Output contents:"
        ls -la output/
        
        # This will be picked up by the next task (upload)