#!/bin/bash
set -euo pipefail

SOURCE=""
DESTINATION=""

# Help function
show_help() {
    cat << EOF
Collect build files produced by Fromager into a single directory.

USAGE:
    $0 [OPTIONS] SOURCE DESTINATION

ARGUMENTS:
    SOURCE                 The high-level Fromager output directory containing wheels, sdists, build
                           sequence summary, and other files.
    DESTINATION            The destination directory to copy the Fromager output to. Directory is
                           created if it does not exist, or cleared otherwise.

OPTIONS:
    --help                          Show this help message

EXAMPLES:
    $0 /tmp/build-output /tmp/artifact

ENVIRONMENT:
    DEBUG=1                        Enable debug mode with verbose output

OUTPUT:
    The script looks for wheels, sdists, and the build sequence summary produced by Fromager into
    a single directory. This is meant to facilitate creating an OCI artifact for those files.
EOF
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --help)
            show_help
            ;;
        -*)
            echo "Error: Unknown option $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
        *)
            if [[ -z "$SOURCE" ]]; then
                SOURCE="$1"
                shift
            elif [[ -z "$DESTINATION" ]]; then
                DESTINATION="$1"
                shift
            else
                echo 'Error: Unexpected number of parameters.' >&2
                exit 1
            fi
            ;;
    esac
done

# Check if required positional argument is provided
if [[ -z "$SOURCE" || -z "$DESTINATION" ]]; then
    echo 'Error: SOURCE and DESTINATION are both required.' >&2
    exit 1
fi

if [[ ! -d "${SOURCE}" ]]; then
    echo "Error: SOURCE directory ${SOURCE} does not exist" >&2
    exit 1
fi

if [ "${DEBUG:-}" = "1" ]; then
    set -x
fi

# Logging function with timestamp
log() {
    echo "[$(date --utc -Ins)] $1" >&2
}

#log "Setting up netrc"
#NETRC=~/.netrc
#cat > $NETRC <<- EOM
#machine packages.redhat.com login ${SERVICE_ACCOUNT_USERNAME} password ${SERVICE_ACCOUNT_PASSWORD}
#EOM
log "Collecting build files..."

# Ensure output directory is clear
rm -rf "${DESTINATION}/{*,.*}" && mkdir -p "${DESTINATION}"

# TODO: The "downloads" name in the path is a misnomer. Those are actually built wheels.
WHEELS_DIR="${SOURCE}/wheels-repo/downloads"
PREBUILT_DIR="${SOURCE}/wheels-repo/prebuilt"

# Copy all built wheels, ignoring prebuilt wheels and wheels already in Pulp
if [ -d "${WHEELS_DIR}" ]; then
    # Enable nullglob so the loop doesn't run if no .whl files exist
    shopt -s nullglob
    
    for file in "${WHEELS_DIR}"/*.whl; do
        FILENAME="${file##*/}"
        
        # 1. Check if wheel is in prebuilt directory, skip if so
        if [[ -f "${PREBUILT_DIR}/${FILENAME}" ]]; then
            log "Skipping ${FILENAME} - found in prebuilt directory"
            continue
        fi
        
        # 2. Check if wheel already exists in Pulp
        #log "Checking if ${FILENAME} exists in Pulp..."
        #RESPONSE=$(curl --netrc --fail --silent "https://packages.redhat.com/api/pulp/trusted-libraries/api/v3/content/python/packages/?filename=${FILENAME}")
        #if echo "$RESPONSE" | grep -q '"count":[1-9]'; then
        #    log "Skipping ${FILENAME} - already exists in Pulp"
        #    continue
        #fi
        
        log "Collecting ${FILENAME}"
        cp "$file" "${DESTINATION}/"
    done
    
    shopt -u nullglob
fi

SDISTS_DIR="${SOURCE}/sdists-repo/builds"
# Copy any source distributions
if [ -d "${SDISTS_DIR}" ]; then
    find "${SDISTS_DIR}" -name '*.tar.gz' -type f \
    -exec cp {} "${DESTINATION}/" \; || true
fi

# Copy all build sequence summary files (one per package)
find "${SOURCE}" -maxdepth 1 -name 'build-sequence-summary-*.json' -type f \
    -exec cp {} "${DESTINATION}/" \; || true

COPIED="$(find "${DESTINATION}" -type f)"
# Verify we have content to push
if [ -z "$COPIED" ]; then
    log "ERROR: No files collected"
    exit 1
fi

log "Collected files:"
echo "${COPIED}" | sort

log "End collect-build-files"
