# This Containerfile is inspired by the Containerfile used by Hermeto:
#   https://github.com/hermetoproject/hermeto/blob/main/Dockerfile

FROM registry.access.redhat.com/ubi9/ubi@sha256:dec374e05cc13ebbc0975c9f521f3db6942d27f8ccdf06b180160490eef8bdbc as ubi

########################
# PREPARE OUR BASE IMAGE
########################
FROM ubi as base
RUN dnf -y install \
    --setopt install_weak_deps=0 \
    --nodocs \
    python3.12 \
    python3.12-devel \
    libffi-devel \
    rust \
    cargo \
    openssl-devel \
    && dnf clean all

###############
# BUILD/INSTALL
###############
FROM base as builder
WORKDIR /src

COPY requirements.txt .
RUN python3.12 -m venv /venv && \
    /venv/bin/pip install -r requirements.txt --no-deps --no-cache-dir --require-hashes

##########################
# ASSEMBLE THE FINAL IMAGE
##########################
FROM base
LABEL maintainer="Red Hat"

COPY --from=builder /venv /venv

COPY scripts/* /usr/local/bin/

RUN \
    ln -s /venv/bin/fromager /usr/local/bin/fromager && \
    ln -s /venv/bin/wheel /usr/local/bin/wheel

# Force the stdout and stderr streams to be unbuffered.
# https://docs.python.org/3/using/cmdline.html#envvar-PYTHONUNBUFFERED
ENV PYTHONUNBUFFERED=1

CMD ["fromager"]
